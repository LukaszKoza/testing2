<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>PoE Prototype - Full Version Part 1</title>
    <style>
        :root { --gold: #d1ad7a; --bg: #0a0a0a; --panel: #1a1610; --border: #3d3522; --rare: #f1c40f; }
        body { background: var(--bg); color: var(--gold); font-family: 'Verdana', sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; user-select: none; overflow: hidden; }
        
        /* GÃ³rne UI */
        .ui-container { width: 800px; padding: 10px; display: flex; justify-content: space-between; background: var(--panel); border-bottom: 2px solid var(--border); box-sizing: border-box; z-index: 10;}
        .controls-hint { font-size: 11px; color: #aaa; text-align: center; line-height: 1.4; }
        .controls-hint b { color: var(--gold); }
        
        canvas { background: radial-gradient(circle, #111 0%, #000 100%); border: 2px solid var(--border); margin-top: 5px; cursor: crosshair; }
        
        /* Panele Okienne */
        .window { display: none; position: absolute; top: 60px; background: rgba(10, 10, 10, 0.95); border: 2px solid var(--border); padding: 20px; z-index: 100; box-shadow: 0 0 50px #000; color: #eee; }
        
        /* Panel Postaci i EQ */
        #character-panel { left: 50%; transform: translateX(-50%); width: 750px; }
        .panels-flex { display: flex; gap: 30px; justify-content: center; }
        
        .paperdoll { display: grid; grid-template-areas: ". helm ." "weapon chest shield" ". legs ."; gap: 15px; background: url('https://prowiki.info/images/thumb/e/e0/Inventory_slots.png/300px-Inventory_slots.png') no-repeat center; background-size: contain; }
        .slot, .inv-slot { width: 64px; height: 64px; background: rgba(20, 20, 20, 0.8); border: 1px solid #444; position: relative; display: flex; align-items: center; justify-content: center; transition: border 0.2s; }
        .slot:hover, .inv-slot:hover { border-color: var(--gold); }
        .inv-grid { display: grid; grid-template-columns: repeat(5, 66px); gap: 4px; }
        
        /* Przedmioty */
        .item { width: 100%; height: 100%; cursor: grab; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; }
        .item:active { cursor: grabbing; }
        
        /* Drzewko Pasywne */
        #passive-panel { width: 900px; height: 600px; left: 50%; transform: translateX(-50%); overflow: hidden; background: #000; border: 3px solid var(--border); }
        #tree-container { position: absolute; width: 4000px; height: 4000px; left: -1500px; top: -1500px; transition: transform 0.05s ease-out; }
        .node { position: absolute; width: 34px; height: 34px; border-radius: 50%; border: 2px solid #333; cursor: pointer; background: #111; z-index: 2; transition: all 0.3s; }
        .node:hover { border-color: #777; transform: scale(1.1); }
        .node.active { background: var(--rare); box-shadow: 0 0 20px var(--rare); border-color: #fff; }
        .connector { position: absolute; background: #222; height: 3px; transform-origin: left center; z-index: 1; pointer-events: none; }
        .connector.active { background: var(--rare); box-shadow: 0 0 8px var(--rare); }

        /* Paski i Tooltip */
        .bar-container { width: 800px; margin-top: 10px; }
        .bar { height: 20px; border: 1px solid var(--border); margin-bottom: 4px; position: relative; background: #111; border-radius: 3px; }
        #hp-fill { background: linear-gradient(to right, #8b0000, #e74c3c); width: 100%; height: 100%; transition: width 0.2s; }
        #mana-fill { background: linear-gradient(to right, #4b0082, #af60ff); width: 100%; height: 100%; transition: width 0.2s; }
        #xp-fill { background: linear-gradient(to right, #1e3c72, #4a90e2); width: 0%; height: 100%; }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 11px; line-height: 20px; color: white; z-index: 2; font-weight: bold; text-shadow: 1px 1px 2px #000; }
        
        #tooltip { display: none; position: fixed; background: rgba(0,0,0,0.95); border: 1px solid var(--gold); padding: 12px; z-index: 1000; pointer-events: none; min-width: 180px; box-shadow: 0 0 15px #000; border-radius: 4px; }
        #sell-zone { margin-top: 15px; border: 2px dashed #e74c3c; padding: 15px; text-align: center; color: #e74c3c; font-weight: bold; transition: background 0.2s; }
        #sell-zone.hover { background: rgba(231, 76, 60, 0.2); }
    </style>
</head>
<body>
    <div class="ui-container">
        <div>LVL: <b id="playerLvl">1</b> | GOLD: <b id="playerGold">0</b></div>
        <div class="controls-hint">
            <b>[I]</b> EQ | <b>[P]</b> Drzewko | <b>[1][2]</b> Potki (HP/MP)<br>
            <b>[SPACE]</b> Atak | <b>[Q]</b> Skill | <b>[LPM]</b> Ruch/Loot
        </div>
        <div>FALA: <b id="waveInfo">1</b></div>
    </div>

    <canvas id="gameCanvas" width="800" height="450"></canvas>

    <div id="character-panel" class="window">
        <h3 style="text-align:center; color:var(--gold)">EKWIPUNEK</h3>
        <div class="panels-flex">
            <div class="paperdoll">
                <div class="slot" data-type="HELM" style="grid-area: helm"></div>
                <div class="slot" data-type="WEAPON" style="grid-area: weapon"></div>
                <div class="slot" data-type="ARMOR" style="grid-area: chest"></div>
                <div class="slot" data-type="SHIELD" style="grid-area: shield"></div>
                <div class="slot" data-type="BOOTS" style="grid-area: legs"></div>
            </div>
            <div>
                <div class="inv-grid" id="invGrid"></div>
                <div id="sell-zone">PRZECIÄ„GNIJ TU, ABY SPRZEDAÄ†</div>
            </div>
        </div>
    </div>

    <div id="passive-panel" class="window">
        <div style="text-align: center; position: absolute; width: 100%; z-index: 10; background: rgba(0,0,0,0.7); padding: 5px 0; border-bottom: 1px solid var(--border);">
            PUNKTY: <b id="passPoints" style="color:var(--rare)">1</b> | <small>PrzeciÄ…gaj tÅ‚o, by nawigowaÄ‡</small>
        </div>
        <div id="tree-container"></div>
    </div>

    <div class="bar-container">
        <div class="bar"><div id="hp-fill"></div><div class="bar-text">HP: <span id="hp-val">100</span> / <span id="hp-max">100</span></div></div>
        <div class="bar"><div id="mana-fill"></div><div class="bar-text">MANA: <span id="mp-val">100</span></div></div>
        <div class="bar"><div id="xp-fill"></div><div class="bar-text">DOÅšWIADCZENIE</div></div>
    </div>
    
    <div id="tooltip"></div>
    <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // Konfiguracja i Stan
    let inventory = [], equipped = {}, enemies = [], groundItems = [], projectiles = [], particles = [];
    let isMouseDown = false, moveTarget = null, mousePos = {x:0, y:0}, draggedItem = null;
    let wave = 1, gold = 0, passivePoints = 1;

    const player = { 
        x: 400, y: 225, hp: 100, maxHp: 100, mana: 100, maxMana: 100, 
        baseDmg: 15, lvl: 1, xp: 0, xpToNext: 100, speed: 3.5,
        luck: 1.0
    };

    // --- SYSTEM WALKI I CZÄ„STECZEK ---
    function spawnWave() {
        for(let i = 0; i < 3 + wave; i++) {
            const side = Math.random() > 0.5;
            enemies.push({
                x: side ? Math.random() * 800 : (Math.random() > 0.5 ? -20 : 820),
                y: !side ? Math.random() * 450 : (Math.random() > 0.5 ? -20 : 470),
                hp: 40 + (wave * 12),
                maxHp: 40 + (wave * 12),
                type: Math.random() > 0.75 ? 'range' : 'melee',
                speed: 1.1 + (Math.random() * 0.4),
                lastShot: 0
            });
        }
        wave++;
        document.getElementById('waveInfo').innerText = wave;
    }

    function singleAttack() {
        // Efekt ataku (stoÅ¼ek)
        const ang = Math.atan2(mousePos.y - player.y, mousePos.x - player.x);
        particles.push({x: player.x, y: player.y, r: 10, maxR: 70, alpha: 1, color: '#fff', type: 'cone', angle: ang});
        
        enemies.forEach(en => {
            const d = Math.hypot(en.x - player.x, en.y - player.y);
            if (d < 85) { // ZasiÄ™g miecza
                en.hp -= player.baseDmg;
                createHitParticle(en.x, en.y, '#e74c3c');
            }
        });
    }

    function useAOE() {
        if (player.mana < 30) return;
        player.mana -= 30;
        particles.push({x: player.x, y: player.y, r: 10, maxR: 130, alpha: 1, color: '#af60ff', type: 'circle'});
        enemies.forEach(en => {
            if (Math.hypot(en.x - player.x, en.y - player.y) < 130) {
                en.hp -= player.baseDmg * 2.5;
                createHitParticle(en.x, en.y, '#af60ff');
            }
        });
    }

    function createHitParticle(x, y, color) {
        for(let i=0; i<3; i++) {
            particles.push({x, y, r: 2, vx: (Math.random()-0.5)*4, vy: (Math.random()-0.5)*4, alpha: 1, color, type: 'spark'});
        }
    }

    // --- PÄ˜TLA LOGIKI (UPDATE) ---
    function update() {
        // Ruch gracza
        if (moveTarget) {
            const d = Math.hypot(moveTarget.x - player.x, moveTarget.y - player.y);
            if (d > 5) {
                player.x += (moveTarget.x - player.x)/d * player.speed;
                player.y += (moveTarget.y - player.y)/d * player.speed;
            } else { moveTarget = null; }
        }

        // AI PrzeciwnikÃ³w
        enemies.forEach((e, idx) => {
            const d = Math.hypot(player.x - e.x, player.y - e.y);
            
            // ReagujÄ… tylko jeÅ›li gracz jest w promieniu 180px
            if (d < 180) {
                if (e.type === 'melee') {
                    e.x += (player.x - e.x)/d * e.speed;
                    e.y += (player.y - e.y)/d * e.speed;
                    if (d < 18) player.hp -= 0.3; // DMG kontaktowy
                } else {
                    // Range trzyma dystans
                    if (d > 120) {
                        e.x += (player.x - e.x)/d * e.speed;
                        e.y += (player.y - e.y)/d * e.speed;
                    }
                    if (Date.now() - e.lastShot > 2500) {
                        const ang = Math.atan2(player.y - e.y, player.x - e.x);
                        projectiles.push({x: e.x, y: e.y, vx: Math.cos(ang)*3.5, vy: Math.sin(ang)*3.5, type: 'enemy'});
                        e.lastShot = Date.now();
                    }
                }
            }

            if (e.hp <= 0) {
                dropLoot(e.x, e.y);
                player.xp += 35;
                enemies.splice(idx, 1);
                if (enemies.length === 0) setTimeout(spawnWave, 1000);
            }
        });

        // Pociski
        projectiles.forEach((p, idx) => {
            p.x += p.vx; p.y += p.vy;
            if (Math.hypot(p.x - player.x, p.y - player.y) < 15) {
                player.hp -= 12;
                projectiles.splice(idx, 1);
            }
            if (p.x < 0 || p.x > 800 || p.y < 0 || p.y > 450) projectiles.splice(idx, 1);
        });

        // Regeneracja Mana
        if (player.mana < player.maxMana) player.mana += 0.05;

        // Level Up
        if (player.xp >= player.xpToNext) {
            player.lvl++;
            player.xp = 0;
            player.xpToNext *= 1.2;
            passivePoints++;
            player.hp = player.maxHp;
            updateUI();
        }

        if (player.hp <= 0) { alert("ZginÄ…Å‚eÅ›! Fala: " + (wave-1)); location.reload(); }

        // CzÄ…steczki
        particles.forEach((p, i) => {
            if (p.type === 'spark') { p.x += p.vx; p.y += p.vy; p.alpha -= 0.02; }
            else { p.r += 3; p.alpha -= 0.04; }
            if(p.alpha <= 0) particles.splice(i, 1);
        });
        
        updateUI();
    }

    // --- RYSOWANIE (DRAW) ---
    function draw() {
        ctx.clearRect(0, 0, 800, 450);

        // Loot na ziemi
        groundItems.forEach(item => {
            ctx.fillStyle = "rgba(0,0,0,0.5)";
            ctx.fillRect(item.x - 20, item.y - 25, 40, 12);
            ctx.fillStyle = item.isCurrency ? item.color : item.rarity.c;
            ctx.font = "bold 10px Arial";
            ctx.textAlign = "center";
            ctx.fillText(item.name, item.x, item.y - 15);
        });

        // Przeciwnicy
        enemies.forEach(e => {
            ctx.fillStyle = e.type === 'range' ? '#4a90e2' : '#e74c3c';
            ctx.beginPath();
            ctx.arc(e.x, e.y, 10, 0, Math.PI*2);
            ctx.fill();
            // Pasek HP wroga
            ctx.fillStyle = '#000'; ctx.fillRect(e.x-10, e.y-15, 20, 3);
            ctx.fillStyle = '#2ecc71'; ctx.fillRect(e.x-10, e.y-15, (e.hp/e.maxHp)*20, 3);
        });

        // Pociski
        projectiles.forEach(p => {
            ctx.fillStyle = "#ff0";
            ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill();
        });

        // Gracz
        ctx.fillStyle = "#f1c40f";
        ctx.shadowBlur = 10; ctx.shadowColor = "#f1c40f";
        ctx.beginPath(); ctx.arc(player.x, player.y, 12, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;

        // Efekty (Particles)
        particles.forEach(p => {
            ctx.strokeStyle = p.color;
            ctx.globalAlpha = p.alpha;
            ctx.lineWidth = 2;
            ctx.beginPath();
            if(p.type === 'cone') ctx.arc(p.x, p.y, p.r, p.angle-0.6, p.angle+0.6);
            else if(p.type === 'circle') ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
            else { ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 2, 2); }
            ctx.stroke();
            ctx.globalAlpha = 1;
        });
    }

    function updateUI() {
        document.getElementById('hp-fill').style.width = (player.hp / player.maxHp * 100) + "%";
        document.getElementById('hp-val').innerText = Math.ceil(player.hp);
        document.getElementById('hp-max').innerText = player.maxHp;
        document.getElementById('mp-val').innerText = Math.ceil(player.mana);
        document.getElementById('mana-fill').style.width = (player.mana / player.maxMana * 100) + "%";
        document.getElementById('passPoints').innerText = passivePoints;
        document.getElementById('playerLvl').innerText = player.lvl;
        document.getElementById('xp-fill').style.width = (player.xp / player.xpToNext * 100) + "%";
    }
    // --- SYSTEM PRZEDMIOTÃ“W I EQ ---
    function renderInventory() {
        const grid = document.getElementById('invGrid');
        grid.innerHTML = "";
        for (let i = 0; i < 20; i++) {
            const slot = document.createElement('div');
            slot.className = "inv-slot";
            const item = inventory[i];
            if (item) {
                const el = document.createElement('div');
                el.className = "item";
                el.style.color = item.color || item.rarity.c;
                el.innerHTML = item.icon || "âš”ï¸";
                el.draggable = true;
                el.onmouseenter = (e) => {
                    let stats = item.isCurrency ? "Waluta rzemieÅ›lnicza" : item.stats.map(s => `${s.n}: +${s.v}`).join('<br>');
                    showTooltip(e, `<b style="color:${el.style.color}">${item.name}</b><br><small>${item.rarity ? item.rarity.n : ''}</small><br>${stats}`);
                };
                el.onmouseleave = hideTooltip;
                el.ondragstart = () => { draggedItem = { item, idx: i, fromSlot: false }; };
                slot.appendChild(el);
            }
            slot.ondragover = e => e.preventDefault();
            slot.ondrop = () => {
                if (draggedItem && draggedItem.item.isCurrency && item && !item.isCurrency) {
                    applyCurrency(draggedItem.item, item, i);
                }
            };
            grid.appendChild(slot);
        }

        document.querySelectorAll('.slot').forEach(slot => {
            const type = slot.dataset.type;
            const eqItem = equipped[type];
            slot.innerHTML = eqItem ? "" : `<small style="color:#444">${type}</small>`;
            if (eqItem) {
                const el = document.createElement('div');
                el.className = "item"; el.style.color = eqItem.rarity.c;
                el.innerHTML = "ðŸ›¡ï¸"; el.draggable = true;
                el.onmouseenter = (e) => showTooltip(e, `<b>${eqItem.name}</b><br>${eqItem.stats.map(s => `${s.n}: +${s.v}`).join('<br>')}`);
                el.onmouseleave = hideTooltip;
                el.ondragstart = () => { draggedItem = { item: eqItem, type: type, fromSlot: true }; };
                slot.appendChild(el);
            }
            slot.ondragover = e => e.preventDefault();
            slot.ondrop = () => {
                if (draggedItem && !draggedItem.fromSlot && draggedItem.item.type === type) {
                    if (equipped[type]) inventory.push(equipped[type]);
                    equipped[type] = draggedItem.item;
                    inventory.splice(draggedItem.idx, 1);
                    renderInventory();
                }
            };
        });
    }

    function applyCurrency(orb, target, idx) {
        if (orb.name === "Chaos Orb") {
            target.stats = [{n: "Power", v: Math.floor(Math.random()*20)+5}];
            target.rarity = {n: "Rare", c: "#f1c40f"};
            target.name = "Rare " + target.type;
        }
        inventory.splice(draggedItem.idx, 1);
        renderInventory();
    }

    function dropLoot(x, y) {
        const roll = Math.random();
        if (roll < 0.15) {
            groundItems.push({x, y, name: "Chaos Orb", isCurrency: true, color: "#d2ad7c", icon: "â—"});
        } else if (roll > 0.7) {
            const types = ["WEAPON", "HELM", "ARMOR", "SHIELD", "BOOTS"];
            const t = types[Math.floor(Math.random()*types.length)];
            groundItems.push({x, y, type: t, name: t, stats: [{n: "Armor", v: 10}], rarity: {n:"Normal", c:"#fff"}});
        }
    }

    // --- DRZEWKO PASYWNE (NAVIGATION & LOGIC) ---
    const nodes = [];
    const treeCont = document.getElementById('tree-container');
    let isPanning = false, panX = -1500, panY = -1500, startX, startY;

    // Przesuwanie drzewka
    document.getElementById('passive-panel').onmousedown = (e) => {
        if(e.target.classList.contains('node')) return;
        isPanning = true; startX = e.clientX - panX; startY = e.clientY - panY;
    };
    window.onmousemove = (e) => {
        if (!isPanning) return;
        panX = e.clientX - startX; panY = e.clientY - startY;
        treeCont.style.transform = `translate(${panX}px, ${panY}px)`;
    };
    window.onmouseup = () => isPanning = false;

    function initPassiveTree() {
        for (let i = 0; i < 80; i++) {
            const angle = i * 0.45;
            const dist = 100 + (i * 22);
            const x = 2000 + Math.cos(angle) * dist;
            const y = 2000 + Math.sin(angle) * dist;
            const node = {
                id: i, x, y, active: i === 0, 
                type: i % 4 === 0 ? "DMG" : "HP", val: 5 + (i % 8), conns: []
            };
            nodes.push(node);
        }
        nodes.forEach((n, i) => {
            if (i < nodes.length - 1) { n.conns.push(i + 1); createConnector(n, nodes[i+1]); }
            createNodeEl(n);
        });
        updateConnectors();
    }

    function createNodeEl(node) {
        const el = document.createElement('div');
        el.className = `node ${node.active ? 'active' : ''}`;
        el.style.left = node.x + 'px'; el.style.top = node.y + 'px';
        el.onmouseenter = (e) => showTooltip(e, `<b>${node.type === "DMG" ? "SiÅ‚a" : "Å»ycie"}</b><br>Daje: +${node.val}`);
        el.onmouseleave = hideTooltip;
        el.onclick = () => {
            const hasActiveNeighbor = nodes.some(n => n.active && (n.conns.includes(node.id) || node.conns.includes(n.id)));
            if (passivePoints > 0 && !node.active && hasActiveNeighbor) {
                node.active = true; passivePoints--;
                if (node.type === "DMG") player.baseDmg += node.val;
                else { player.maxHp += node.val; player.hp += node.val; }
                updateUI(); el.classList.add('active'); updateConnectors();
            }
        };
        treeCont.appendChild(el);
    }

    function createConnector(n1, n2) {
        const conn = document.createElement('div');
        conn.className = 'connector';
        const dist = Math.hypot(n2.x - n1.x, n2.y - n1.y);
        const ang = Math.atan2(n2.y - n1.y, n2.x - n1.x);
        conn.style.width = dist + 'px'; conn.style.left = (n1.x + 17) + 'px'; conn.style.top = (n1.y + 17) + 'px';
        conn.style.transform = `rotate(${ang}rad)`;
        conn.id = `conn-${Math.min(n1.id, n2.id)}-${Math.max(n1.id, n2.id)}`;
        treeCont.appendChild(conn);
    }

    function updateConnectors() {
        nodes.forEach(n => n.conns.forEach(tid => {
            const c = document.getElementById(`conn-${Math.min(n.id, tid)}-${Math.max(n.id, tid)}`);
            if (c && n.active && nodes[tid].active) c.classList.add('active');
        }));
    }

    // --- OBSÅUGA WEJÅšCIA ---
    window.onkeydown = e => {
        const key = e.key.toLowerCase();
        if (key === '1') player.hp = Math.min(player.maxHp, player.hp + 40);
        if (key === '2') player.mana = Math.min(player.maxMana, player.mana + 40);
        if (key === 'i') { 
            const p = document.getElementById('character-panel');
            p.style.display = p.style.display === 'block' ? 'none' : 'block';
        }
        if (key === 'p') {
            const p = document.getElementById('passive-panel');
            p.style.display = p.style.display === 'block' ? 'none' : 'block';
        }
        if (key === 'q') useAOE();
        if (key === ' ') singleAttack();
    };

    canvas.onmousedown = e => {
        const r = canvas.getBoundingClientRect();
        const mx = e.clientX - r.left, my = e.clientY - r.top;
        const itemIdx = groundItems.findIndex(i => Math.hypot(mx-i.x, my-i.y) < 30);
        if (itemIdx > -1) {
            if (inventory.length < 20) {
                inventory.push(groundItems[itemIdx]);
                groundItems.splice(itemIdx, 1);
                renderInventory();
            }
        } else { moveTarget = {x: mx, y: my}; isMouseDown = true; }
    };
    canvas.onmousemove = e => {
        const r = canvas.getBoundingClientRect();
        mousePos = {x: e.clientX - r.left, y: e.clientY - r.top};
        if (isMouseDown) moveTarget = mousePos;
    };
    window.onmouseup = () => isMouseDown = false;

    document.getElementById('sell-zone').ondragover = e => e.preventDefault();
    document.getElementById('sell-zone').ondrop = () => {
        gold += 25; document.getElementById('playerGold').innerText = gold;
        if(draggedItem.fromSlot) delete equipped[draggedItem.type];
        else inventory.splice(draggedItem.idx, 1);
        renderInventory();
    };

    // START
    initPassiveTree(); spawnWave(); renderInventory();
    setInterval(() => { update(); draw(); }, 16);
</script>
</body>
</html>